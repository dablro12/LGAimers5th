import pandas as pd
from utils.data import handle_inf_and_fillna

def feature_engineering(df):
    # -------------------------
    # 1. 시술 정보 관련 변수
    # -------------------------
    #%% 중요 변수 List
    df['나이 대비 임신 확률'] = df['총 임신 횟수'] / df['시술 당시 나이']
    df['나이 대비 임신 시도 기간'] = df['임신 시도 또는 마지막 임신 경과 연수'] / df['시술 당시 나이']

    df['나이 대비 임신 확률'] = handle_inf_and_fillna(df['나이 대비 임신 확률'], fill_value=1)
    df['나이 대비 임신 시도 기간'] = handle_inf_and_fillna(df['나이 대비 임신 시도 기간'], fill_value=1)

    # 시술 횟수 관련 변수
    df['총 임신 성공률'] = df['총 임신 횟수'] / df['총 시술 횟수'] # 0 - 1 : Accuracy 0.5 vs 0.1 Accuracy 0 : <->
    df['총 임신 성공률'] = handle_inf_and_fillna(df['총 임신 성공률'], fill_value=0.5)

    df['IVF 임신 성공률'] = df['IVF 임신 횟수'] / df['IVF 시술 횟수']
    df['IVF 임신 성공률'] = handle_inf_and_fillna(df['IVF 임신 성공률'], fill_value=0.5)

    df['DI 임신 성공률'] = df['DI 임신 횟수'] / df['DI 시술 횟수']
    df['DI 임신 성공률'] = handle_inf_and_fillna(df['DI 임신 성공률'], fill_value=0.5)

    df['시술당 평균 배아 생성 수'] = df['총 생성 배아 수'] / df['총 시술 횟수']
    df['시술당 평균 배아 생성 수'] = handle_inf_and_fillna(df['시술당 평균 배아 생성 수'], fill_value=0)

    df['시술당 평균 이식 배아 수'] = df['이식된 배아 수'] / df['총 시술 횟수']
    df['시술당 평균 이식 배아 수'] = handle_inf_and_fillna(df['시술당 평균 이식 배아 수'], fill_value=0)

    #%% 배아 생성 주요 이유
    """
    """
    train['배아 생성 주요 이유'] = train['배아 생성 주요 이유'].fillna('0')
    train['배아 생성 주요 이유'] = train['배아 생성 주요 이유'].str.split(',')
    train = train.explode('배아 생성 주요 이유') # 여러 행 분리 
    train['배아 생성 주요 이유'] = train['배아 생성 주요 이유'].str.strip() # 좌우 공백 제거

    train['배아 생성 주요 이유'] = le.fit_transform(train['배아 생성 주요 이유'])
    # -------------------------
    # 2. 임신 및 출산 정보 관련 변수
    # -------------------------
    df['임신 시도 대비 성공률'] = df['총 임신 횟수'] / (df['임신 시도 또는 마지막 임신 경과 연수'] + 1e-10)
    
    #%% 미중요 변수 List 
    df['시술 경험 점수'] = (df['총 시술 횟수'] + df['클리닉 내 총 시술 횟수']) / 2

    # -------------------------
    # 2. 임신 및 출산 정보 관련 변수
    # -------------------------
    df['총 출산 성공률'] = df['총 출산 횟수'] / df['총 임신 횟수']
    df['총 출산 성공률'] = handle_inf_and_fillna(df['총 출산 성공률'], fill_value=0.5)

    df['IVF 출산 성공률'] = df['IVF 출산 횟수'] / df['IVF 시술 횟수']
    df['IVF 출산 성공률'] = handle_inf_and_fillna(df['IVF 출산 성공률'], fill_value=0.5)

    df['DI 출산 성공률'] = df['DI 출산 횟수'] / df['DI 시술 횟수']
    df['DI 출산 성공률'] = handle_inf_and_fillna(df['DI 출산 성공률'], fill_value=0.5)

    df['출산 유지율'] = df['총 출산 횟수'] / (df['총 임신 횟수'] + 1e-10)

    # -------------------------
    # 3. 배아 관련 정보 변수
    # -------------------------
    df['미세주입 배아 생성 확률'] = df['미세주입에서 생성된 배아 수'] / (df['미세주입된 난자 수'] + 1e-10)
    df['배아 이식 대비 최종 출산 성공률'] = df['총 출산 횟수'] / (df['이식된 배아 수'] + 1e-10)
    df['총 배아 이식 확률'] = df['이식된 배아 수'] / (df['총 생성 배아 수'] + 1e-10)
    df['미세주입 배아 이식 확률'] = df['미세주입 배아 이식 수'] / (df['미세주입에서 생성된 배아 수'] + 1e-10)

    df['저장된 배아 사용률'] = df['이식된 배아 수'] / (df['저장된 배아 수'] + 1e-10)
    df['해동 배아 사용률'] = df['해동된 배아 수'] / (df['저장된 배아 수'] + 1e-10)
    df["배아 저장 대비 이식 기간"] = df["배아 이식 경과일"] / (df["저장된 배아 수"] + 1e-10)

    # -------------------------
    # 4. 난자 관련 정보 변수
    # -------------------------
    df['난자 채취 대비 배아 생성 기간'] = df['배아 이식 경과일'] / (df['수집된 신선 난자 수'] + 1e-10)
    df['난자 혼합 비율'] = df['혼합된 난자 수'] / (df['수집된 신선 난자 수'] + 1e-10)

    # -------------------------
    # 5. 불임 원인 정보 변수
    # -------------------------
    # 여성 불임 세부 지표
    if '불임 원인 - 자궁내막증' in df.columns and '불임 원인 - 자궁경부 문제' in df.columns:
        df['여성 불임 세부 지표'] = df['불임 원인 - 자궁내막증'] + df['불임 원인 - 자궁경부 문제']

    # 남성 정자 종합 지표
    if ('불임 원인 - 정자 농도' in df.columns and 
        '불임 원인 - 정자 운동성' in df.columns and 
        '불임 원인 - 정자 형태' in df.columns):
        df['남성 정자 종합 지표'] = (
            df['불임 원인 - 정자 농도'] 
            + df['불임 원인 - 정자 운동성'] 
            + df['불임 원인 - 정자 형태']
        )

    # -------------------------
    # 6. 기타 정보 변수
    # -------------------------
    if '착상 전 유전 검사 사용 여부' in df.columns:
        df['PGS 사용'] = df['착상 전 유전 검사 사용 여부'].astype(int)
    if '착상 전 유전 진단 사용 여부' in df.columns:
        df['PGD 사용'] = df['착상 전 유전 진단 사용 여부'].astype(int)

    # -------------------------
    # 7. 배란 관련 정보
    # -------------------------
    if '배란 유도 유형' in df.columns:
        df = pd.get_dummies(df, columns=['배란 유도 유형'], prefix='배란유도')

    # -------------------------
    # 8. 시간 경과 관련 변수
    # -------------------------
    df['난자 채취-이식 경과 비율'] = df['배아 이식 경과일'] / (df['난자 채취 경과일'] + 1e-10)
    df['배아 해동 이후 이식 기간'] = df['배아 이식 경과일'] - df['배아 해동 경과일']

    return df
